@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Horizons</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

    <style>
        body {
            background: #f2f7f5;
        }

        header.navbar, nav.navbar {
            background: #247158 !important;
            padding: 0.7rem 1.5rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .navbar-brand, .nav-link {
            color: #fff !important;
            font-weight: 500;
        }

        .btn-logout {
            background: #ffcc00;
            color: #4b3300;
            border: none;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 8px;
        }

        /* 🤖 AI Chat */
        #ai-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #247158;
            color: white;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 9999;
        }

        #ai-chat-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 340px;
            height: 450px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 9999;
        }

        #ai-chat-header {
            background: #247158;
            color: white;
            padding: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        #ai-chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            font-size: 14px;
            background: #f8f9fa;
        }

        .user-msg {
            background: #d1f0e1;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 6px;
        }

        .ai-msg {
            background: white;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 6px;
            border: 1px solid #ddd;
        }

        #ai-chat-input-area {
            display: flex;
            border-top: 1px solid #ddd;
        }

        #ai-chat-input {
            flex: 1;
            border: none;
            padding: 10px;
            outline: none;
        }

        #ai-chat-input-area button {
            background: #247158;
            color: white;
            border: none;
            padding: 0 15px;
            cursor: pointer;
        }
    </style>

    @RenderSection("Styles", required: false)
</head>

<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <a class="navbar-brand" asp-controller="Home" asp-action="Index">Horizons</a>

            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">

                    <!-- Дестинации -->
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Destination" asp-action="Index">
                            Дестинации
                        </a>
                    </li>

                    <!-- ВРЪЩАМЕ СЕЗОННОСТ -->
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Destination" asp-action="Seasons">
                            🌤 Сезонност
                        </a>
                    </li>

                    <!-- НОВ БУТОН ТУР ГАЙДОВЕ -->
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Guide" asp-action="Index">
                            🧭 Тур гайдове
                        </a>
                    </li>

                </ul>

                <ul class="navbar-nav ms-auto">
                    @if (SignInManager.IsSignedIn(User))
                    {
                        <li class="nav-item">
                            <span class="nav-link">👤 @User.Identity!.Name</span>
                        </li>

                        <li class="nav-item">
                            <form method="post"
                                  asp-area="Identity"
                                  asp-page="/Account/Logout">
                                <button class="btn btn-logout btn-sm">Изход</button>
                            </form>
                        </li>
                    }
                    else
                    {
                        <li class="nav-item">
                            <a class="nav-link"
                               asp-area="Identity"
                               asp-page="/Account/Login">
                                Вход
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </nav>
    </header>

    <div class="container mt-4 mb-4">
        @RenderBody()
    </div>

    <footer class="text-center text-muted mt-5 py-3">
        © @DateTime.Now.Year - Horizons
    </footer>

    <!-- 🤖 AI Chat -->
    <div id="ai-chat-button" onclick="toggleChat()">🤖</div>

    <div id="ai-chat-container">
        <div id="ai-chat-header">
            AI Travel Assistant
            <span onclick="toggleChat()" style="cursor:pointer;">✖</span>
        </div>
        <div id="ai-chat-messages"></div>
        <div id="ai-chat-input-area">
            <input type="text" id="ai-chat-input" placeholder="Попитай ме..." />
            <button onclick="sendMessage()">➤</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function toggleChat() {
            let chat = document.getElementById("ai-chat-container");
            chat.style.display = chat.style.display === "flex" ? "none" : "flex";
        }

        document.getElementById("ai-chat-input")
            .addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });

        async function sendMessage() {
            let input = document.getElementById("ai-chat-input");
            let message = input.value.trim();
            if (!message) return;

            let messages = document.getElementById("ai-chat-messages");

            messages.innerHTML += `<div class="user-msg"><b>Ти:</b> ${message}</div>`;
            input.value = "";

            let response = await fetch("/AI/Ask", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "message=" + encodeURIComponent(message)
            });

            let data = await response.json();
            data = data.replace(/\n/g, "<br>");

            messages.innerHTML += `<div class="ai-msg"><b>AI:</b><br>${data}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }
    </script>

    @RenderSection("Scripts", required: false)

</body>
</html>
